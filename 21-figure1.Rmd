---
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.width=10, fig.height=7) 
library(tidyverse) 
library(patchwork)  # for combining figures
library(gplots)     # for heatmap.2
library(ggtree)    # for trees
library(ape)   # for as.phylo
load("tcr_objects.Rdata")
```

# Figure 1



## Human Clone Tissue Summary

```{r}
figures_path <- file.path("figures", "fig1")
dir.create(figures_path, showWarnings = FALSE)

tissue_annotations = read.csv("data/updated_colors_dendrograms.csv")
diversity <- read.csv("tables/st4.csv") %>% 
  left_join(tcr_sample_metadata) %>% 
  left_join(tissue_annotations, by="tissue")

human_patient_colors <- c("mediumblue", "navy", "red", "yellow", "green4", "lightskyblue", "saddlebrown", "gray75", "gray45", "gray 85")
names(human_patient_colors) <- paste("Patient", LETTERS[1:10])




jitter <- position_jitter(width = 0.0, height = 0.1)

jitter2 <- position_jitter(width = 0.15, height = 0.01)


div_base <- ggplot(diversity %>% filter(org == "Human"), aes(y=reorder(tissue_label_fig1, desc(anatomic_order))))

(fig1b <- ggplot(data.frame(nclones=sapply(clones_per_pt, n_distinct)) %>% rownames_to_column("indv_label") %>% 
                   filter(grepl("Patient", indv_label )),
                 aes(y=indv_label,x=nclones, fill=indv_label)) +
    geom_bar(stat="identity", orientation = "y", alpha=.9, width = .6) +
    scale_x_log10(
      expand=c(0,0),
      breaks = c(1 %o% 10^(-6:6)),
      labels = scales::trans_format("log10", scales::math_format(10^.x))
    ) +
    scale_y_discrete(limits=rev, name="") +
    theme_classic() + 
    scale_fill_manual(values = human_patient_colors, breaks = names(human_patient_colors), guide="none"))

ggsave(plot=fig1b ,height=5,width=6, filename=file.path(figures_path, "fig1b.pdf"))

(fig1c <- div_base +
    geom_point(aes(x=len, fill = indv_label), size = 4, shape=21, alpha = .9, position = jitter) +
    theme_classic()  +
    scale_x_log10(
      breaks = c(1 %o% 10^(-6:6)),
      labels = scales::trans_format("log10", scales::math_format(10^.x))
    ) +
    theme(legend.position = "right") +
    labs(x="unique clones", y="") +
    #scale_y_discrete(breaks=tissue_annotations$tissue, labels=tissue_annotations$tissue_label) +
    theme(axis.text.y = element_text(size = 10, face = "bold")) + 
    scale_fill_manual(values = human_patient_colors, breaks = names(human_patient_colors)) +
    theme(axis.text.x = element_text(size = 8, hjust = 0, face = "bold")))


ggsave(plot=fig1c ,height=5,width=6, filename=file.path(figures_path, "fig1c.pdf"))




(fig1d = div_base +
  geom_point( aes(x=max_productive_frequency, fill = indv_label), size=4, shape=21, alpha = .9, position = jitter) +
  theme_classic() + 
    labs(x="clone frequency (%)", y="") +
 theme(legend.position = "right") + 
#  scale_y_discrete(breaks=tissue_annotations$tissue, labels=tissue_annotations$tissue_label) +
  theme(axis.text.y = element_text(size = 10, face = "bold")) + 
  scale_fill_manual(values = human_patient_colors, breaks = names(human_patient_colors)) +
  theme(axis.text.x = element_text(size = 8, angle =0, hjust = 0, face = "bold")))

ggsave(plot=fig1d ,height=5,width=6,dpi=200, 
       filename=file.path(figures_path, "fig1d.pdf"), 
       useDingbats=FALSE)

#this is the plot for making the the clonality distribution for figure 1 


(fig1e = div_base +
  geom_point( aes(x=clonality, fill = indv_label), size=4, shape=21, alpha = .9, position = jitter) +
  theme_classic()  +
  labs(y="clonality", x="") +
  theme(legend.position = "right") + 
#  scale_y_discrete(breaks=tissue_annotations$tissue, labels=tissue_annotations$tissue_label) +
  theme(axis.text.y = element_text(size = 10, face = "bold")) +  
  scale_fill_manual(values = human_patient_colors, breaks = names(human_patient_colors)) +
  theme(axis.text.x = element_text(size = 8, angle = 0, hjust = 0, face = "bold")))

ggsave(plot=fig1e ,height=5,width=6,dpi=200, 
       filename=file.path(figures_path, "fig1e.pdf"), 
       useDingbats=FALSE)

ggsave(patchwork::plot_spacer()  + fig1b + fig1c + fig1d + fig1e + plot_layout(widths = c(1, .7, 1,1,1), nrow=1, guides="collect") + plot_annotation(tag_levels = "A"), width = 24, height=5, filename = file.path(figures_path,"fig1.pdf"))
```



## Mouse Figure 1 additions

```{r}
div_base_mouse <- ggplot(diversity %>% filter(org != "Human"), aes(y=reorder(tissue_label_fig1, desc(anatomic_order))))



(mouse_fig1e = div_base_mouse +
  geom_point( aes(x=clonality, fill = indv_label), size=4, shape=21, alpha = .9, position = jitter) +
  theme_classic()  +
  labs(y="clonality", x="") +
  theme(legend.position = "right") + 
#  scale_y_discrete(breaks=tissue_annotations$tissue, labels=tissue_annotations$tissue_label) +
  theme(axis.text.y = element_text(size = 10, face = "bold")) +  
  theme(axis.text.x = element_text(size = 8, angle = 0, hjust = 0, face = "bold")))

```



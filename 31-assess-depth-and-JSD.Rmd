---
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r setup-TCR, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.width=10, fig.height=7) 
library(tidyverse) 
library(patchwork)  # for combining figures
library(gplots)     # for heatmap.2
library(ggtree)    # for trees
library(doParallel)
library(ape)   # for as.phylo
library(abdiv)
theme_set(theme_classic())
```

# Processing the raw TCR data
### Parsing and processing the TCR Data

The following chunk serves two purposes: reading in the TCR data, and calculating the JSD correlations based on the TCR profiles.  This takes a while, so the results are saved in an object called `tcr_objects.Rdata`. If this object is not found, it will create it. 

```{R}
tcr_objects_path <- "tcr_objects.Rdata"
load(tcr_objects_path)

topn <- 1000
depth_threshold <- 5000

patients <- tcr_sample_metadata %>% filter(grepl("Patient", indv_label)) %>% pull(indv_label) %>% unique()

results <- list()

for (depth_threshold in c(250, 500, 1000, 5000)){
  for (topn in c(50, 100, 500, 1000, 5000)) {
    for (pt in patients){
      print(paste("processing", pt))
      pt_samples <- tcr_sample_metadata %>% filter(indv_label == pt)
      print("  - topn")
      tcr_topn_filtered <- tcr_raw %>% 
        filter(sample_name %in% pt_samples$sample_name) %>% 
        select(sample_name, rearrangement, amino_acid, productive_frequency, productive_rearrangements) %>%
        group_by(sample_name) %>% 
        slice_max(order_by = productive_frequency, n = topn) %>%
        data.table::as.data.table() %>% 
        data.table::dcast(sample_name~rearrangement, fill = 0, value.var="productive_frequency" ) %>%
        column_to_rownames("sample_name") %>% 
        data.matrix()
      
      
      
      system.time({tcr_topn_filtered_jsd  <- philentropy::JSD(tcr_topn_filtered, est.prob = "empirical")})
      
      colnames(tcr_topn_filtered_jsd) <- rownames(tcr_topn_filtered_jsd)  <- rownames(tcr_topn_filtered)
      topndf <- tcr_topn_filtered_jsd  %>% as_tibble(rownames = "sampleA") %>% 
        pivot_longer(cols = -sampleA, names_to = "sampleB") %>%
        mutate(metric=paste0(topn, "_top_JSD"))
      
      
      
      print("  - depth ...")
      
      # rescale to a set depth: 
      # productive_frequency * productive_templates gives the actual productive templates (productive tempaltes is the total per sample)
      # we then templates/totaldepth = X/set depth, or (setdepth * templates )/total_depth
      # Then, we remove the fractional ones that we would not observe at that set depth_threshold
      
      tcr_depth_filtered <- tcr_raw %>% 
        filter(sample_name %in% pt_samples$sample_name) %>% 
        select(sample_name, rearrangement, amino_acid, productive_frequency, productive_templates, productive_rearrangements) %>%
        mutate(lowdepth_templates = ((productive_frequency * productive_templates) *depth_threshold) / productive_templates) %>%
        filter(lowdepth_templates >=1) %>%
        mutate(lowdepth_productive_frequency=lowdepth_templates/depth_threshold) %>% 
        data.table::as.data.table() %>% 
        data.table::dcast(sample_name~rearrangement, fill = 0, value.var="productive_frequency" ) %>%
        column_to_rownames("sample_name") %>% 
        data.matrix()
      system.time({tcr_depth_filtered_jsd  <- philentropy::JSD(tcr_depth_filtered, est.prob = "empirical")})
      
      colnames(tcr_depth_filtered_jsd) <- rownames(tcr_depth_filtered_jsd)  <- rownames(tcr_depth_filtered)
      depthdf <- tcr_depth_filtered_jsd  %>% as_tibble(rownames = "sampleA") %>% 
        pivot_longer(cols = -sampleA, names_to = "sampleB") %>%
        mutate(metric=paste0(depth_threshold, "_depth_JSD"))
      
      results[[paste0(pt, "_depth", depth_threshold, "_topn", topn)]] <- bind_rows(depthdf, topndf) 
    }
  }
}

# fix usage of this to differentiate total clones (ie unique clones) from total tempaltes
total_clones <- tcr_corrs %>% filter(sample1 == sample2) %>% select(sample1, overlapping_clones) %>% distinct() %>%
  rename(total_clones=overlapping_clones)

resultsdf <- bind_rows(results, .id = "indv_label_depth_topn") %>%
  mutate(
    indv_label = gsub("(.+)_depth.*", "\\1", indv_label_depth_topn),
    depth_threshold = as.numeric(gsub(".*depth(\\d+)_.*", "\\1", indv_label_depth_topn)),
    topn_threshold = as.numeric(gsub(".*topn(\\d+)$", "\\1", indv_label_depth_topn)),
  ) %>%
  left_join(tcr_corrs %>% rename(sampleA=sample1, sampleB=sample2) %>% select(sampleA, sampleB, JSD),  by = c("sampleA", "sampleB")) %>%
  mutate(sort_order = ifelse(grepl("_depth", metric), depth_threshold, 1e6 + topn_threshold),
         metric = forcats::fct_reorder(metric, sort_order)) %>% 
  left_join(total_clones, by=c("sampleA"="sample1")) %>%
  left_join(total_clones, by=c("sampleB"="sample1"))  %>%
  mutate()



(p_depth_comparisons <- ggplot(resultsdf, 
                               aes(x=JSD, y=value, color=ifelse(grepl("depth", metric), "Depth", "Top N"), shape=indv_label)) + 
    scale_shape_manual(values=1:15) + 
  geom_abline(intercept = 0, slope = 1, linetype="dotted")+
  geom_point(alpha=.7) + 
  scale_color_manual(values = c("forestgreen", "firebrick")) + 
  theme_classic() + 
  labs(x="Raw JSD", y="Filtered JSD", color="Filtering", shape="Patient") + 
    facet_wrap(~metric)
)

ggsave(p_depth_comparisons, filename = file.path("figures", "depth_effect_on_jsd.pdf"))

```


## How different filtering schemes relate to the raw JSD scores
```{R}
(p_depth_comparisons_bytotal <- ggplot(resultsdf, 
                               aes(x=JSD, y=value, color=total_clones.x, shape=indv_label)) + 
    scale_shape_manual(values=1:15) + 
  geom_abline(intercept = 0, slope = 1, linetype="dotted")+
  geom_point(alpha=.5) + 
  scale_color_gradient(low = "blue", high="red") + 
  theme_classic() + 
  labs(x="Raw JSD", y="Filtered JSD", shape="Patient") + 
    facet_wrap(~metric)
)


```


## 

```{r}
samples_productive_templates <- tcr_raw %>% select(sample_name, productive_templates)  %>% distinct()
depth_data <- tcr_corrs %>% 
         left_join(tcr_sample_metadata %>% select(sample_name, org, indv_label,samp_type, gvhd) %>% rename(sample1=sample_name), by="sample1")%>% 
         left_join(tcr_sample_metadata %>% select(sample_name, org, indv_label, samp_type, gvhd) %>% rename(sample2=sample_name), by="sample2")%>% 
  left_join(samples_productive_templates, by=c("sample1"="sample_name")) %>%
  left_join(samples_productive_templates, by=c("sample2"="sample_name")) %>% 
  filter(!grepl("pretx_blood", sample1),  !grepl("pretx_blood", sample2)) %>% 
  filter(!grepl("[Dd]onor", sample1),  !grepl("[Dd]onor", sample2))  %>% 
  filter(indv_label.x == indv_label.y)  %>%
  filter(sample1 != "PtD_autopsy_marrow_TCRB", sample2 != "PtD_autopsy_marrow_TCRB") %>%
  filter(sample1 != sample2) %>% 
  mutate(
    productive_templates_total_similarity = pmin(productive_templates.x, productive_templates.y)/pmax(productive_templates.x, productive_templates.y),
    pair_max_templates = pmax(productive_templates.x, productive_templates.y),
    pair_min_templates = pmin(productive_templates.x, productive_templates.y),
         )%>%
  rowwise() %>% 
  mutate(
    gmean = sqrt(productive_templates.x*productive_templates.y),
    mean = mean(c(productive_templates.x, productive_templates.y)),
  )

ggplot( depth_data,
          aes(x=productive_templates.x, y=productive_templates.y)) + 
  geom_point(aes(color=JSD), alpha=.3) + 
  scale_color_gradient(low="blue", high = "red") + 
  scale_y_log10() + scale_x_log10()

ggplot( depth_data,
          aes(x=gmean, y=JSD)) + 
  geom_point(aes(color=JSD), alpha=.3) + 
  scale_color_gradient(low="blue", high = "red") + 
  scale_y_log10() + scale_x_log10() + 
  geom_smooth(method="lm") + 
  facet_grid(gvhd.x~org.x)  +
#   
# ggplot( depth_data,
#           aes(x=productive_templates_total_similarity, y=gmean)) + 
#   geom_point(aes(color=JSD), alpha=.3) + 
#   scale_color_gradient(low="blue", high = "red") + 
# #  scale_y_log10() + scale_x_log10() + 
#   geom_smooth(method="lm") + 
#   facet_grid(gvhd.x~org.x) +

  ggplot( depth_data,
          aes(x=productive_templates_total_similarity, y=JSD)) + 
  geom_point(aes(color=JSD), alpha=.3) + 
  scale_color_gradient(low="blue", high = "red") + 
#  scale_y_log10() + scale_x_log10() + 
  geom_smooth(method="lm") + 
  facet_grid(gvhd.x~org.x) 

summary(lm(JSD ~gmean,  data=depth_data %>% filter(org.x == "Human" )))
summary(lm(JSD ~gmean,  data=depth_data %>% filter(org.x != "Human" )))


ggplot( depth_data ,
          aes(x=gmean, y=JSD)) + 
  geom_point(aes(color=JSD), alpha=.3) + 
  scale_color_gradient(low="blue", high = "red") + 
  scale_y_log10() + scale_x_log10() + 
  geom_smooth(method="lm") + 
  facet_grid(~org.x)  + 
  ggpubr::stat_cor()

ggplot( depth_data %>% filter(org.x == "Human"),
          aes(x=mean, y=JSD)) + 
  geom_point(aes(color=JSD), alpha=.3) + 
  scale_color_gradient(low="blue", high = "red") + 
  scale_y_log10() + scale_x_log10() + 
  geom_smooth(method="lm") + 
  facet_grid(~org.x)   

#human
  ggplot( depth_data %>% filter(org.x == "Human"),
          aes(x=productive_templates_total_similarity, y=JSD)) + 
  geom_point(aes(color=pair_min_templates), alpha=.3) + 
  scale_color_gradient(low="blue", high = "red") + 
  facet_wrap(~indv_label.x) 
  ggplot( depth_data %>% filter(org.x == "Human"),
          aes(x=gmean, y=JSD)) + 
  geom_point(aes(color=pair_min_templates), alpha=.3) + 
  scale_color_gradient(low="blue", high = "red") + 
  facet_wrap(~indv_label.x, scales="free") 
  
#mouse
  ggplot( depth_data %>% filter(org.x != "Human"),
          aes(x=productive_templates_total_similarity, y=JSD)) + 
  geom_point(aes(color=pair_min_templates), alpha=.3) + 
  scale_color_gradient(low="blue", high = "red") + 
  facet_wrap(~indv_label.x)  
  ggplot( depth_data %>% filter(org.x != "Human"),
          aes(x=gmean, y=JSD)) + 
  geom_point(aes(color=pair_min_templates), alpha=.3) + 
  scale_color_gradient(low="blue", high = "red") + 
  facet_wrap(~indv_label.x, scales="free") 
```


## calculating JSDs after pair-wise equalizing

```{R}   

tcr_corrs_equalized <- depth_data 
tcr_corrs_equalized$JSD_norm <- NA


for (i in 1:nrow(tcr_corrs_equalized)){
  these_samples <- c(tcr_corrs_equalized$sample1[i], tcr_corrs_equalized$sample2[i] )
  depth_threshold <- min(tcr_corrs_equalized$productive_templates.x[i], tcr_corrs_equalized$productive_templates.y[i] )
  tcr_depth_filtered <- tcr_raw %>% 
    filter(sample_name %in% these_samples) %>% 
    select(sample_name, rearrangement, amino_acid, templates, productive_templates, productive_frequency) %>%
    mutate(lowdepth_templates = (templates *depth_threshold) / productive_templates) %>%
    filter(lowdepth_templates >=1) %>%
    group_by(sample_name) %>%
    mutate(total_lowdepth_templates = sum(lowdepth_templates)) %>%
    ungroup() %>%
    mutate(normalized_lowdepth_templates = (lowdepth_templates * min(total_lowdepth_templates)) / total_lowdepth_templates) %>%
    mutate(lowdepth_productive_frequency = normalized_lowdepth_templates / min(total_lowdepth_templates)) %>%
    data.table::as.data.table() %>% 
    data.table::dcast(sample_name~rearrangement, fill = 0, value.var="lowdepth_productive_frequency" ) %>%
    column_to_rownames("sample_name") %>% 
    data.matrix()
  tcr_corrs_equalized$JSD_norm[i] <- philentropy::JSD(tcr_depth_filtered, est.prob = "empirical")

}

ggplot(tcr_corrs_equalized, aes(x=JSD, y=JSD_norm)) + 
  geom_point() +
  geom_abline(intercept = 0, slope = 1) + 
  coord_equal(xlim=c(0, 1), ylim=c(0, 1))



```

## Trees on normalized JSDs


```{r}
for (pt in unique(tcr_corrs_equalized %>% pull(indv_label.x))){
pt_a_jsd <- plot_patient_tcr_tree(df = tcr_corrs_equalized %>%ungroup() %>%
                        filter(!is.na(JSD_norm)) %>% 
                        filter(indv_label.x == pt) %>% 
                        left_join(tcr_sample_metadata, by=c("sample1"="sample_name")) %>% 
                        left_join(tcr_sample_metadata, by=c("sample2"="sample_name")),
                        metri = "JSD", patient = pt)
pt_a_jsd_norm <- plot_patient_tcr_tree(df = tcr_corrs_equalized %>%ungroup() %>%
                        filter(!is.na(JSD_norm)) %>% 
                        filter(indv_label.x == pt) %>% 
                        left_join(tcr_sample_metadata, by=c("sample1"="sample_name")) %>% 
                        left_join(tcr_sample_metadata, by=c("sample2"="sample_name")),
                        metri = "JSD_norm", patient = pt)
ggsave(filename = file.path("figures", paste0("compare_JSD_normJSD_", pt, ".pdf")), plot =  pt_a_jsd + pt_a_jsd_norm + plot_annotation(tag_levels = "A", subtitle = "A is JSD, B is normalized JSD"))

}

```









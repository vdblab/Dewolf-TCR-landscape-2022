---
output: html_document
editor_options: 
  chunk_output_type: console
---

## Venn 

```{R 24-figure4-1 }
if (interactive()) load("tcr_objects.Rdata")
fig4_figs_path <- file.path("figures", "fig4")
dir.create(fig4_figs_path, showWarnings = FALSE)


(V <- venn::venn(clones_per_pt[paste("Patient", LETTERS[1:7])], ilab = TRUE, zcolor = "style", opacity = .2, ggplot = TRUE))



ggsave(
  plot = V, height = 6, width = 6, dpi = 200,
  filename = file.path(fig4_figs_path, "fig4_venn_plot_7.pdf"),
  useDingbats = FALSE
)


(Vaa <- venn::venn(aa_per_pt[paste("Patient", LETTERS[1:7])], ilab = TRUE, zcolor = "style", opacity = .2, ggplot = TRUE))
ggsave(
  plot = Vaa, height = 6, width = 6,
  filename = file.path(fig4_figs_path, "fig4_venn_plot_7_aa.pdf"),
  useDingbats = FALSE
)

(Vbioid <- venn::venn(bioid_per_pt[paste("Patient", LETTERS[1:7])], ilab = TRUE, zcolor = "style", opacity = .2, ggplot = TRUE))
ggsave(
  plot = Vbioid, height = 6, width = 6,
  filename = file.path(fig4_figs_path, "fig4_venn_plot_7_bioid.pdf"),
  useDingbats = FALSE
)



# write.csv(paired_patients, "overlapping_clones_com.csv", row.names = F)

Vaa + Vbioid
```



```{R 24-figure4-2 }
# make one for each set because venns can only handle so many
for (thisrep in c("rep1", "rep2", "rep3")) {
  Vmouse <- venn::venn(clones_per_pt[grep(thisrep, names(clones_per_pt))], ilab = TRUE, zcolor = "style", opacity = .2, ggplot = TRUE)

  ggsave(
    plot = Vmouse, height = 6, width = 6,
    filename = file.path(fig4_figs_path, paste("fig4_venn_plot_7_mouse", thisrep, ".pdf")),
    useDingbats = FALSE
  )
}

Vmouse_donor <- venn::venn(aa_per_pt[grep("Donor", names(aa_per_pt))], ilab = TRUE, zcolor = "style", opacity = .2, ggplot = TRUE)

ggsave(
  plot = Vmouse_donor, height = 6, width = 6,
  filename = file.path("figures", "fig6", "6D-mouse_donor_venn_plot_AA.pdf"),
  useDingbats = FALSE
)
```


## GLIPH2 Analysis

Data for GLIPH2 were prepared as follows:
```{r eval=FALSE}
fns <- list.files('data/raw_TCR_data/', full.names = T)
# there are NA in the v gene and J gene
all <- fns %>% 
  map(~ read_tsv(., col_types = cols(.default = "c")) %>% 
        filter(frame_type == 'In') %>% 
        select(CDR3b = cdr3_amino_acid,
               v_family,
               TRBV = v_gene,
               TRBJ = j_gene,
               sample_name = sample_name,
               templates) %>% 
        mutate(CDR3a = "NA") %>% 
        mutate(sample_name = str_replace(sample_name, '_TCRB$', '')) %>% 
        mutate(subject = str_extract(sample_name, '^Pt(\\d)+')) %>% 
        mutate(condition = str_replace(sample_name, '^Pt(\\d)+_','')) %>% 
        mutate(`subject:condition` = str_glue('{subject}:{condition}')) %>% 
        select(-sample_name, -subject, -condition) %>% 
        mutate(templates = as.numeric(templates))   %>% 
        mutate(TRBV = if_else(is.na(TRBV), v_family, TRBV)) %>% 
        group_by(CDR3b, TRBV, TRBJ, CDR3a, `subject:condition`) %>% 
        summarise(count = sum(templates)) %>% 
        mutate(TRBV = str_replace(TRBV, 'TCRB.',''),
               TRBJ = str_replace(TRBJ, 'TCRB.','')) %>% 
        mutate(TRBV = str_replace(TRBV, '/.+$',''),
               TRBJ = str_replace(TRBJ, '/.+$','')) %>% 
        separate(TRBV, into = c('v1','v2'), sep = '-') %>% 
        separate(TRBJ, into = c('j1','j2'), sep = '-')  %>% 
        mutate(v1 = str_remove(v1, "^0+"),
               v2 = str_remove(v2, "^0+"),
               j1 = str_remove(j1, "^0+"),
               j2 = str_remove(j2, "^0+")) %>% 
        mutate(TRBV = if_else(is.na(v1), "NA", as.character(str_glue('TRBV{v1}-{v2}'))),
               TRBJ = if_else(is.na(j1), "NA", as.character(str_glue('TRBJ{j1}-{j2}'))))  %>%
        mutate(TRBV = str_replace(TRBV, '-NA','')) %>% 
        select(-v1, -v2,-j1, -j2) %>% 
        select(CDR3b, TRBV, TRBJ, CDR3a, `subject:condition`, count)) %>% 
        bind_rows()

all %>% filter(grepl("^Pt", sample_name)) %>% 
  write_tsv('data/human_data_for_gliph2.tsv', col_names = F)
all %>% filter(!grepl("^Pt", sample_name)) %>% 
  write_tsv('data/mouse_data_for_gliph2.tsv', col_names = F)
```


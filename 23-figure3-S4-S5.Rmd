---
output: html_document
editor_options: 
  chunk_output_type: console
---
# Aluvial Plots

```{R 23-figure3-1 }
library(RColorBrewer)
library(tidyverse) 
library(ggalluvial)
if (interactive()) load("tcr_objects.Rdata")

figures_path <- file.path("figures", "alluvials")
dir.create(figures_path, showWarnings = FALSE)


get_top_clones_data <-  function(df, topn=10){
  #max_productive_frequency is a sanity check
   top_clones <- df %>% 
    group_by(sample_name) %>%
    slice_max(n = topn, order_by=productive_frequency, with_ties = TRUE) %>%
    arrange(desc(productive_frequency)) %>% 
    #mutate(top_tissue_clone_rank=row_number()) %>% 
    mutate(max_productive_frequency = max(productive_frequency)) %>% 
    select(sample_name, rearrangement,  productive_frequency, max_productive_frequency)
  top_n_data <- df %>% 
    group_by(sample_name) %>%
    arrange(desc(productive_frequency))%>%
    mutate(orig_tissue_clone_rank=rank(-productive_frequency,  ties.method = "first", na.last = "keep")) %>% 
    ungroup() %>% 
    filter(rearrangement %in% top_clones$rearrangement) 
  return(list(top_clones = top_clones, top_n_data=top_n_data))
}
make_alluvial_dataset <- function(tcr_data, tcr_sample_metadata, tissue_metadata, ref_org="Human", ref_pt="Patient B", ref_tissue="duodenum", topn=10, ref_color="mediumpurple"){
  metadata_of_interest <- tcr_sample_metadata %>%
    filter(
      org==ref_org,
      indv_label == ref_pt
    )
  if (!ref_tissue %in% metadata_of_interest$tissue){stop(paste("Tissue", ref_tissue, "not sampled in", ref_pt))}
  samples_of_interest <- metadata_of_interest  %>% pull(sample_name)
  res <- get_top_clones_data(df=tcr_data %>%filter(sample_name %in% samples_of_interest), topn = topn)
  top_clones <- res$top_clones
  top_n_data <- res$top_n_data
  n_distinct(top_clones$rearrangement)
  top_n_data_wide <- top_n_data %>% 
    select(rearrangement, tissue, productive_frequency) %>%
    # dplyr::group_by(rearrangement, tissue) %>%
    # dplyr::summarise(n = dplyr::n(), .groups = "drop") %>%
    # dplyr::filter(n > 1L) 
    pivot_wider(id_cols = rearrangement, names_from=tissue, values_from=productive_frequency, values_fill = 0) %>% 
    column_to_rownames("rearrangement")
  
  
  
  top_10_ascending = top_n_data_wide %>%
    arrange(desc(get(ref_tissue))) %>% 
    data.frame() %>%
    mutate(key=row_number())
  
  #now that we have the dataframe with just the clones we want and their frequencies in all the tissues, we will re-format the data for alluvium
  # top_10_ascending = data.frame(top_10_ascending)
  # top_10_ascending$key = 1:nrow(top_10_ascending) #this adds a "key" or "NT ID" to each row 
  # top_10_ascending$key #this is the number of rows
  
  plot_data <- top_10_ascending %>% 
    pivot_longer(cols = -key, names_to = "tissue", values_to="freq") %>%
    mutate(frequency_nudged = freq + rnorm(n=n(),  mean = 10E-7, sd = 10E-9)) %>% 
    data.frame() %>% 
    left_join(tissue_metadata) %>% 
    group_by(tissue) %>%
    mutate(tissue_total = sum(freq),
           thislabel=ifelse(tissue == ref_tissue & row_number()==1, "*", ""))
  
  p_ <- ggplot(plot_data,
                aes(x = reorder(tissue_label, anatomic_order), stratum = frequency_nudged, y=frequency_nudged, alluvium = key,
                    fill = ifelse(key%in%1:topn, ref_color, "gray75"))) +
      labs(x="", y="", fill = "Nucleotide ID", title="") +
      geom_flow(stat = "alluvium", curve_type = "sigmoid", color = "gray45", size = .3) +
      geom_stratum(alpha = 1) +
      geom_text(aes(y=tissue_total *1.1, label=thislabel), size=15) +
  # consider , color=NA) + 
      scale_fill_identity() +
      theme_classic() +
      theme(
        axis.text.y = element_text(size = 15, color = "black"),
        legend.position = "right",
        axis.text.x = element_text(size = 15, angle = -30, color = "black", hjust = 0)
      ) +
      scale_y_continuous(expand = c(0,0)) 
  

  return(list(top_n_data=top_n_data,
              top_clones=top_clones,
              top_n_data_wide=top_n_data_wide,
              plot_data=plot_data,
              p_=p_))
}

thisdata <- make_alluvial_dataset(tcr_raw, ref_org = "Human", ref_pt = "Patient D", ref_tissue = "duodenum", tcr_sample_metadata = tcr_sample_metadata, tissue_metadata = tissue_annotations, topn = 10)




plots_to_make <- list(
  "Patient A" = c(org="Human", topn=10, ref_tissue="duodenum", ref_color="mediumpurple", f="S4A"),
  "Patient B" = c(org="Human", topn=10, ref_tissue="duodenum", ref_color="mediumpurple", f="S4B"),
  "Patient C" = c(org="Human", topn=10, ref_tissue="duodenum", ref_color="mediumpurple", f="S4C"),
  "Patient D" = c(org="Human", topn=10, ref_tissue="duodenum", ref_color="mediumpurple", f="S4D"),
  "Patient E" = c(org="Human", topn=10, ref_tissue="duodenum", ref_color="mediumpurple", f="S4E"),
  "Patient F" = c(org="Human", topn=10, ref_tissue="duodenum", ref_color="mediumpurple", f="3C"),
  "Patient G" = c(org="Human", topn=10, ref_tissue="small_intestine", ref_color="mediumpurple", f="S4F"),
  "Patient H" = c(org="Human", topn=10, ref_tissue="duodenum", ref_color="mediumpurple", f="S4H"),
  "Patient I" = c(org="Human", topn=10, ref_tissue="duodenum", ref_color="mediumpurple", f="3D"),
  "Patient J" = c(org="Human", topn=10, ref_tissue="jejunum", ref_color="mediumpurple", f="S4G"),
  "Patient A" = c(org="Human", topn=10, ref_tissue="autopsy_blood", ref_color="mediumpurple", f="S4I"),
  "Patient D" = c(org="Human", topn=10, ref_tissue="autopsy_blood", ref_color="mediumpurple", f="3E"),
  "Patient F" = c(org="Human", topn=10, ref_tissue="autopsy_blood", ref_color="mediumpurple", f="S4J"),
  "Patient G" = c(org="Human", topn=10, ref_tissue="autopsy_blood", ref_color="mediumpurple", f="S4K"),
  "Recipient 7, rep2, day 14" = c(org="Mouse", ref_tissue="skin", topn=10, ref_color="forestgreen", f="S4A")
)

  
for (i in seq_along(plots_to_make)){
  thing = plots_to_make[[i]]
  
  thisdata <- make_alluvial_dataset(tcr_raw, tcr_sample_metadata, ref_org=thing["org"],
                                    ref_tissue = thing["ref_tissue"], tissue_metadata = tissue_annotations,
                                    ref_pt=names(plots_to_make)[i], topn=as.numeric(thing["topn"]))
  
  
  ggsave(plot=thisdata$p_ ,height=5,width=10,dpi=200, 
         filename=file.path(figures_path, paste0(thing["f"],"_", names(plots_to_make)[i], ".pdf")), 
         useDingbats=FALSE)
}
```


### Mouse Alluvials
```{r}
mouse_plots_to_make <- list(
  "Recipient 7, rep2, day 14" = c(org="Mouse", ref_tissue="skin", topn=10, ref_color="forestgreen", f="S4A")
)

for (i in seq_along(mouse_plots_to_make)){
  thing = mouse_plots_to_make[[i]]
  
  # identify which mouse donor
  rep = tcr_sample_metadata %>% filter(indv_label ==names(mouse_plots_to_make)[i]) %>% pull(exp_rep) %>% unique()
  tmpmetadata <- tcr_sample_metadata %>% filter(grepl(paste0("Donor_", rep, "_"), sample_name))
  # add a dummy row to create that mouse's donor "tissue" to metadata so it is included in plots
  tmpmetadata$indv_label <- names(mouse_plots_to_make)[i]
  thisdata <- make_alluvial_dataset(tcr_raw, rbind(tcr_sample_metadata, tmpmetadata), ref_org=thing["org"],
                                    ref_tissue = thing["ref_tissue"], tissue_metadata = tissue_annotations,
                                    ref_pt=names(mouse_plots_to_make)[i], topn=as.numeric(thing["topn"]))
  thisdata$p_
}
```





## S5


```{r 23-figure3-2 }
figures_path_s5 <- file.path("figures", "S5")
dir.create(figures_path_s5, showWarnings = FALSE)

# remake to exlude graft in the top


tissue_annotations <- read.csv("data/updated_colors_dendrograms.csv")
tissues_to_completely_exclude = c("heart", "kidney", "Heart", "Kidney")

cols_to_exclude_from_ranking = c("rearrangement", "amino_acid")

supp_data_file_list <- list()
for (pat in tcr_sample_metadata %>% filter(org == "Human") %>% pull(indv_label) %>% unique){
  thisdata <- get_top_clones_data(df=tcr_raw %>% filter(indv_label == all_of(pat), !tissue %in% tissues_to_completely_exclude), topn = 10)
  
  # Patient A's donor sample consists almost entirely of singltons. We do not plot that for this sample
  if (pat == "Patient A"){
    thisdata  <- thisdata %>% filter(tissue != "graft_blood") 
  }

  #n_distinct(thisdata$top_n_data$rearrangement)
  
  #top_n_data %>% select(sample_name, productive_frequency, orig_tissue_clone_rank)
  
  
  
  hmap_data_pre  <- thisdata$top_n_data %>% left_join(tissue_annotations) %>% arrange(anatomic_order)  %>% 
    select(rearrangement, amino_acid, rearrangement_trunc, v_gene, j_gene,  tissue, tissue_label, orig_tissue_clone_rank) %>% 
    select(-tissue) %>% 
    pivot_wider(names_from = tissue_label, values_from = orig_tissue_clone_rank) 
  hmap_data <- hmap_data_pre %>% select(-v_gene, -j_gene, -rearrangement_trunc)
  # add pseudoranks for absent clones
  tmphmap_data_for_ordering <- hmap_data[,!colnames(hmap_data) %in% cols_to_exclude_from_ranking]
  tmphmap_data_for_ordering <- hmap_data %>% select(-rearrangement, -amino_acid)
  
  pseudorank = round(max(na.rm = TRUE, tmphmap_data_for_ordering) * 1.5)
  tmphmap_data_for_ordering[is.na(tmphmap_data_for_ordering)] <- pseudorank
  
  mean_order = apply(tmphmap_data_for_ordering, 1, mean)
  med_order = apply(tmphmap_data_for_ordering, 1, median)
  clustered <- hclust(dist(tmphmap_data_for_ordering %>% as.matrix))
  
  # these_cols_to_exclude_from_ranking <- quos(cols_to_exclude_from_ranking[cols_to_exclude_from_ranking %in% colnames(hmap_data)])
  if ("Pre-tx PBMCs" %in% hmap_data){
    hmap_data <- hmap_data  %>% relocate(pretx_blood, .after = last_col()) 
  }
  hmap_data$order <- mean_order
  ordered_hmap_data <- hmap_data %>% 
    arrange(across(any_of(c("order", "pre-tx Blood")))) %>% 
    select(-order) 
  
  mat <- ordered_hmap_data %>% select(-amino_acid)%>% select(-rearrangement) %>% as.matrix()
  rownames(mat) <- gsub("^(.{10}).*", "\\1", ordered_hmap_data$rearrangement)
  rownames(mat) <- ordered_hmap_data$amino_acid
  
  tmp <- data.frame(tissue=unique(thisdata$top_n_data$tissue)) %>% left_join(tissue_annotations) %>% mutate(rn=tissue_label) %>% column_to_rownames("rn")
  mat_colors=list(tissue_label=tmp %>% pull(S5_colors))
  names(mat_colors$tissue_label) <- rownames(tmp)
  pdf(file=file.path(figures_path_s5, paste0(pat, ".pdf")))
  # if (pat == "Patient A"){
  #   mat <- mat[, colnames(mat)[colnames(mat) != "Graft/Blood"] ]
  #   mat <- mat[rowSums(mat, na.rm = TRUE) !=0 , ]
  # }
  pheatmap::pheatmap(na_col = "grey70",
    mat               = mat ,
    color             = c(topo.colors(50), rep("grey90", 5)),
    border_color      = "black",
    show_colnames     = TRUE,
    show_rownames     = TRUE,
    annotation_col    = tmp %>% select(tissue_label),
    annotation_colors = mat_colors,
    breaks            = seq(1,55,1),
    # annotation_row    = clone_group,
    # annotation_clors  = row_color,
    drop_levels       = TRUE,
    angle_col = 315, 
      
    cluster_rows = F,
    cluster_cols = F,
    fontsize          = 8,
    # main              = paste(paste(pt_ind, num, sep = "_"), "heatmap", sep = "_")
  )
  dev.off()
  # pdf(file=file.path(figures_path_s5, paste0(pat, "_clean.pdf")))
  # pheatmap::pheatmap(
  #   mat               = mat ,
  #   color             = topo.colors(50),
  #   border_color      = "black",
  #   show_colnames     = FALSE,
  #   show_rownames     = FALSE,
  #   annotation_col    = tmp %>% select(tissue),
  #   annotation_colors = mat_colors,
  #   breaks            = seq(1,50,1),
  #   # annotation_row    = clone_group,
  #   # annotation_clors  = row_color,
  #   drop_levels       = TRUE,
  #   cluster_rows = F,
  #   cluster_cols = F,
  #   fontsize          = 10,
  #   # main              = paste(paste(pt_ind, num, sep = "_"), "heatmap", sep = "_")
  # )
  # dev.off()
  supp_data_file_list[[pat]]  <- hmap_data_pre %>% select(-rearrangement) %>% select(2,1,3,4) %>% mutate(patient=pat)
  }
write.csv(bind_rows(supp_data_file_list), file = "tables/stX-topclone-IDs.csv")
```
  
  
  
